html
    include main_parts/_head
    include main_parts/_header
    body
        .content
            include views/_chat

            script.

                function initSendButton(chat) {
                    var input = $('.input')
                    var ChatMessage = Parse.Object.extend('ChatMessage')
                    $('.send').click(function() {
                        var msgTxt = input.val()
                        var message = new ChatMessage()
                        message.set('chat', chat)
                        message.set('message', msgTxt)
                        message.set('sentBy', Parse.User.current())
                        input.val('')
                        message.save()
                    })
                }

                var chatKey;
                var chat;
                var msgQuery;
                var subscription;
                var messages;

                var addMessage = function(message) {
                    messages.push(message)

                    var cl;

                    if (message.get('sentBy').id === Parse.User.current().id) {
                        cl = '.right'
                    } else {
                        cl = '.left'
                    }

                    var $msg = $('<div></div>')
                    $msg.text(message.get('message'))
                    $msg.addClass(cl)
                    $msg.addClass('message')

                    $('.message-container').append($msg)
                }

                Promise.resolve().then(function() {
                    var userQuery = new Parse.Query(Parse.User)
                    userQuery.include('mentor')
                    return userQuery.get(Parse.User.current().id)
                }).then(function(user) {
                
                    var mentor = user.get('mentor')
                    chatKey = user.id + mentor.id;

                    var chatQuery = new Parse.Query('Chat')
                    chatQuery.equalTo('key', chatKey)

                    return chatQuery.first()
                }).then(function(c) {
                    if (!c) {
                        var Chat = Parse.Object.extend('Chat')
                        c = new Chat()
                        c.set('key', chatKey)
                        return c.save()
                    } else {
                        return Parse.Promise.resolve(c)
                    }
                })
                .then(function(c) {
                    chat = c;

                    initSendButton(chat)

                    msgQuery = new Parse.Query('ChatMessage')
                    msgQuery.equalTo('chat', c)
                    msgQuery.limit(20)
                    msgQuery.include('sentBy')


                    return msgQuery.find()
                })
                .then(function(msgs) {
                    messages = msgs

                    messages.map(function(message) {
                        addMessage(message)
                    })

                    var q = new Parse.Query('ChatMessage')
                    q.equalTo('chat', chat)
                    q.include('sentBy')

                    subscription = q.subscribe()
                    subscription.on('create', function(message) {
                        addMessage(message)
                    });

                })
