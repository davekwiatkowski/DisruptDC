<html><head><title>Involv</title><meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0"/><link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet"/><link href="dist/css/main.css" rel="stylesheet"/><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script><script src="dist/js/main.js"></script><script src="https://npmcdn.com/parse/dist/parse.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.17.1/moment.min.js"><link rel="apple-touch-icon" sizes="57x57" href="http://davekwiatkowski.github.io/DisruptDC/favicons/apple-icon-57x57.png"/><link rel="apple-touch-icon" sizes="60x60" href="http://davekwiatkowski.github.io/DisruptDC/favicons/apple-icon-60x60.png"/><link rel="apple-touch-icon" sizes="72x72" href="http://davekwiatkowski.github.io/DisruptDC/favicons/apple-icon-72x72.png"/><link rel="apple-touch-icon" sizes="76x76" href="http://davekwiatkowski.github.io/DisruptDC/favicons/apple-icon-76x76.png"/><link rel="apple-touch-icon" sizes="114x114" href="http://davekwiatkowski.github.io/DisruptDC/favicons/apple-icon-114x114.png"/><link rel="apple-touch-icon" sizes="120x120" href="http://davekwiatkowski.github.io/DisruptDC/favicons/apple-icon-120x120.png"/><link rel="apple-touch-icon" sizes="144x144" href="http://davekwiatkowski.github.io/DisruptDC/favicons/apple-icon-144x144.png"/><link rel="apple-touch-icon" sizes="152x152" href="http://davekwiatkowski.github.io/DisruptDC/favicons/apple-icon-152x152.png"/><link rel="apple-touch-icon" sizes="180x180" href="http://davekwiatkowski.github.io/DisruptDC/favicons/apple-icon-180x180.png"/><link rel="icon" type="image/png" sizes="192x192" href="http://davekwiatkowski.github.io/DisruptDC/favicons/android-icon-192x192.png"/><link rel="icon" type="image/png" sizes="32x32" href="http://davekwiatkowski.github.io/DisruptDC/favicons/favicon-32x32.png"/><link rel="icon" type="image/png" sizes="96x96" href="http://davekwiatkowski.github.io/DisruptDC/favicons/favicon-96x96.png"/><link rel="icon" type="image/png" sizes="16x16" href="http://davekwiatkowski.github.io/DisruptDC/favicons/favicon-16x16.png"/><link rel="manifest" href="http://davekwiatkowski.github.io/DisruptDC/favicons/manifest.json"/><link name="msapplication-TileColor" content="#ffffff"/><link name="msapplication-TileImage" content="/ms-icon-144x144.png"/><link name="theme-color" content="#ffffff"/></script></head><header><nav><div class="logo-container"><a class="logo" href="index.html">Involv</a></div><div class="navigation-items"><div id="burger"><div id="icon"></div><div id="drop-down"><a class="events-select">Events</a><a class="chat-select">Chat</a><a class="profile-select">Profile</a><a class="log-out">Log Out</a></div></div><div id="no-burger"><a class="events-select">Events</a><a class="chat-select">Chat</a><a class="profile-select">Profile</a><a class="log-out">Log Out</a></div></div></nav></header><body><div class="content"><input class="input" type="text"/><button class="send">Send</button><script>function initSendButton(chat) {
    var input = $('.input');
    var ChatMessage = Parse.Object.extend('ChatMessage');
    $('.send').click(function() {
        var msgTxt = input.val();
        var message = new ChatMessage();
        message.set('chat', chat);
        message.set('message', msgTxt);
        input.val('');
        message.save();
    })
}

var chatKey;
var chat;
var msgQuery;
var subscription;
var messages;

function addMessage(message) {
    messages.push(message);
}

Promise.resolve().then(function() {
    var userQuery = new Parse.Query(Parse.User);
    userQuery.include('mentor');
    return userQuery.get(Parse.User.current().id);
}).then(function(user) {

    var mentor = user.get('mentor');
    chatKey = user.id + mentor.id;

    var chatQuery = new Parse.Query('Chat');
    chatQuery.equalTo('key', chatKey);

    return chatQuery.first();
}).then(function(c) {
        if (!c) {
            var Chat = Parse.Object.extend('Chat');
            c = new Chat();
            c.set('key', chatKey);
            return c.save();
        } else {
            return Promise.resolve(c);
        }
    })
    .then(function(c) {
        chat = c;

        initSendButton(chat);

        msgQuery = new Parse.Query('ChatMessage');
        msgQuery.equalTo('chat', c);
        msgQuery.limit(20);

        return msgQuery.find();
    })
    .then(function(msgs) {
        messages = msgs;
        console.log(msgs);

        var q = new Parse.Query('ChatMessage');
        q.equalTo('chat', chat);

        subscription = q.subscribe();
        subscription.on('create', function(message) {
            msgs.push(message);
            console.log(message.get('message'));
        });

        subscription.on('update', function(message) {
            msgs.push(message);
            console.log(message.get('message'));
        });

    })</script></div></body></html>